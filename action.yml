name: 'Copyright Infringement Detection'
description: 'Detects copyright infringement in pull requests using AI analysis'
author: 'NTT Inc.'

inputs:
  github-token:
    description: 'GitHub token for API access'
    required: true
  aacs-url:
    description: 'AACS API endpoint URL'
    required: true
  aacs-api-key:
    description: 'AACS API key'
    required: true
  huggingface-token:
    description: 'Hugging Face token for model access'
    required: true
  container-registry:
    description: 'Container registry (default: ghcr.io)'
    required: false
    default: 'ghcr.io'
  image-name:
    description: 'Container image name'
    required: false
    default: 'copyright-checker'
  pr-number:
    description: 'Pull request number (auto-detected if not provided)'
    required: false

outputs:
  result:
    description: 'Analysis result'
    value: ${{ steps.analysis.outputs.result }}
  violations-found:
    description: 'Whether violations were found'
    value: ${{ steps.analysis.outputs.violations-found }}

runs:
  using: 'composite'
  steps:
    - name: Enable Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.container-registry }}
        username: ${{ github.actor }}
        password: ${{ inputs.github-token }}

    - name: Generate Container Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ inputs.container-registry }}/${{ github.repository_owner }}/${{ inputs.image-name }}
        tags: |
          type=raw,value=latest
          type=sha,prefix=,suffix=,format=short

    - name: Build and Push Container Image
      uses: docker/build-push-action@v5
      with:
        context: ${{ github.action_path }}
        file: ${{ github.action_path }}/docker/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=registry,ref=${{ inputs.container-registry }}/${{ github.repository_owner }}/${{ inputs.image-name }}:buildcache
        cache-to: type=registry,ref=${{ inputs.container-registry }}/${{ github.repository_owner }}/${{ inputs.image-name }}:buildcache,mode=max

    - name: Determine PR Number
      id: pr-number
      shell: bash
      run: |
        # Determine PR number from various sources
        if [[ -n "${{ inputs.pr-number }}" && "${{ inputs.pr-number }}" != "" ]]; then
          PR_NUMBER="${{ inputs.pr-number }}"
          echo "Using PR number from input: $PR_NUMBER"
        elif [[ -n "${{ github.event.pull_request.number }}" ]]; then
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "Using PR number from event: $PR_NUMBER"
        else
          echo "ERROR: Could not determine PR number"
          echo "Input pr-number: '${{ inputs.pr-number }}'"
          echo "Event PR number: '${{ github.event.pull_request.number }}'"
          echo "Event name: '${{ github.event_name }}'"
          exit 1
        fi
        
        echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "Final determined PR number: $PR_NUMBER"

    - name: Debug Container Contents
      shell: bash
      run: |
        echo "=== Container Contents Debug ==="
        docker run --rm ${{ steps.meta.outputs.tags }} ls -la /app/ || echo "Container or files not found"

    - name: Run Copyright Infringement Analysis
      id: analysis
      shell: bash
      run: |
        echo "Running copyright infringement detection for PR #${{ steps.pr-number.outputs.pr-number }}"
        echo "Using container image: ${{ steps.meta.outputs.tags }}"
        echo "Container registry: ${{ inputs.container-registry }}"
        echo "GitHub event: ${{ github.event_name }}"
        
        docker run --rm \
          -e GITHUB_TOKEN="${{ inputs.github-token }}" \
          -e AACS="${{ inputs.aacs-url }}" \
          -e AACSAPIkey="${{ inputs.aacs-api-key }}" \
          -e HUGGINGFACE_TOKEN="${{ inputs.huggingface-token }}" \
          -e GITHUB_REPOSITORY="${{ github.repository }}" \
          -e GITHUB_HEAD_REF="${{ github.head_ref }}" \
          -e GITHUB_BASE_REF="${{ github.base_ref }}" \
          -e PR_NUMBER="${{ steps.pr-number.outputs.pr-number }}" \
          -v ${{ github.workspace }}:/workspace \
          -w /app \
          ${{ steps.meta.outputs.tags }} \
          bash -c "
            echo 'Container environment:'
            echo 'Working directory:' \$(pwd)
            echo 'Available files in /app:' && ls -la /app/
            echo 'Available files in /workspace:' && ls -la /workspace/ | head -10
            echo 'PR Number from environment:' \$PR_NUMBER
            echo 'All environment variables:' && env | grep -E '(PR_NUMBER|GITHUB_|AACS)' | sort
            git config --global --add safe.directory /workspace
            cd /workspace
            python3 /app/testScript.py
          "